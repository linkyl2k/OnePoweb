{% extends "base.html" %}
{% block content %}
<div class="container my-5" style="max-width: 600px;">
  
  <!-- Header -->
  <div class="text-center mb-4">
    <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, {% if plan == 'pro' %}#10b981, #34d399{% else %}#2ea0ff, #34c3ff{% endif %}); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px {% if plan == 'pro' %}rgba(16,185,129,0.3){% else %}rgba(46,160,255,0.3){% endif %};">
      <i class="bi bi-{% if plan == 'pro' %}rocket-takeoff{% else %}star{% endif %}" style="font-size: 1.75rem; color: #fff;"></i>
    </div>
    <h2 style="color: #fff;">{% if current_lang == 'he' %}תשלום עבור {{ plan|upper }}{% elif current_lang == 'en' %}Payment for {{ plan|upper }}{% else %}Оплата за {{ plan|upper }}{% endif %}</h2>
    <p class="text-muted">{% if current_lang == 'he' %}מנוי חודשי ל-OnePoweb{% elif current_lang == 'en' %}Monthly subscription to OnePoweb{% else %}Месячная подписка на OnePoweb{% endif %}</p>
  </div>

  <!-- Order Summary -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="mb-4">
        <i class="bi bi-receipt me-2" style="color: #2ea0ff;"></i>
        {{ t('checkout_order_summary') }}
      </h5>
      
      <div class="d-flex justify-content-between mb-2">
        <span>{% if current_lang == 'he' %}חבילת {{ plan|upper }} (חודשי){% elif current_lang == 'en' %}{{ plan|upper }} Plan (Monthly){% else %}План {{ plan|upper }} (Месячный){% endif %}</span>
        <span>${{ base_price_usd }} <small class="text-muted">(USD)</small></span>
      </div>
      
      <hr style="border-color: var(--border);">
      
      <div class="d-flex justify-content-between" style="font-size: 1.25rem; font-weight: bold;">
        <span>{% if current_lang == 'he' %}סה"כ לתשלום{% elif current_lang == 'en' %}Total to Pay{% else %}Итого к оплате{% endif %}</span>
        <span style="color: {% if plan == 'pro' %}#34d399{% else %}#34c3ff{% endif %};">
          ${{ net_price_usd }} <small class="text-muted">(USD)</small>
        </span>
      </div>
      <div class="small text-muted mt-2">
        <i class="bi bi-info-circle me-1"></i> {% if current_lang == 'he' %}תשלום דרך PayPal ב-USD. PayPal ימיר אוטומטית למטבע שלך.{% elif current_lang == 'en' %}Payment via PayPal in USD. PayPal will automatically convert to your currency.{% else %}Оплата через PayPal в USD. PayPal автоматически конвертирует в вашу валюту.{% endif %}
      </div>
    </div>
  </div>

  <!-- Plan Features -->
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">{% if current_lang == 'he' %}מה כלול בחבילה:{% elif current_lang == 'en' %}What's included in the plan:{% else %}Что включено в план:{% endif %}</h6>
      <ul class="list-unstyled mb-0">
        {% if plan == 'pro' %}
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}ניתוחים ללא הגבלה{% elif current_lang == 'en' %}Unlimited analyses{% else %}Неограниченные анализы{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}גרפים מתקדמים{% elif current_lang == 'en' %}Advanced graphs{% else %}Продвинутые графики{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}ייצוא PDF מותאם{% elif current_lang == 'en' %}Custom PDF export{% else %}Настраиваемый экспорт PDF{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}תובנות AI מותאמות אישית{% elif current_lang == 'en' %}Personalized AI insights{% else %}Персонализированные AI-инсайты{% endif %}</li>
        <li class="mb-0"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}תמיכה עדיפות{% elif current_lang == 'en' %}Priority support{% else %}Приоритетная поддержка{% endif %}</li>
        {% else %}
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}עד 50 ניתוחים בחודש{% elif current_lang == 'en' %}Up to 50 analyses per month{% else %}До 50 анализов в месяц{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}גרפים בסיסיים{% elif current_lang == 'en' %}Basic graphs{% else %}Базовые графики{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}ייצוא PDF{% elif current_lang == 'en' %}PDF export{% else %}Экспорт PDF{% endif %}</li>
        <li class="mb-0"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}תמיכה באימייל{% elif current_lang == 'en' %}Email support{% else %}Поддержка по email{% endif %}</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <!-- PayPal Button Container -->
  {% if paypal_client_id and paypal_client_id != 'YOUR_PAYPAL_CLIENT_ID' %}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">
        <i class="bi bi-shield-check me-2" style="color: #34d399;"></i>
        {% if current_lang == 'he' %}תשלום מאובטח{% elif current_lang == 'en' %}Secure Payment{% else %}Безопасная оплата{% endif %}
      </h6>
      
      <!-- Card Fields (inline form) -->
      <div id="card-form" class="mb-3" style="display: none;">
        <div class="mb-3">
          <label class="form-label small text-muted">{% if current_lang == 'he' %}מספר כרטיס{% elif current_lang == 'en' %}Card Number{% else %}Номер карты{% endif %}</label>
          <div id="card-number" style="height: 45px; border: 1px solid #ced4da; border-radius: 6px; padding: 12px;"></div>
        </div>
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label small text-muted">{% if current_lang == 'he' %}תוקף{% elif current_lang == 'en' %}Expiry{% else %}Срок действия{% endif %}</label>
            <div id="card-expiry" style="height: 45px; border: 1px solid #ced4da; border-radius: 6px; padding: 12px;"></div>
          </div>
          <div class="col-6 mb-3">
            <label class="form-label small text-muted">CVV</label>
            <div id="card-cvv" style="height: 45px; border: 1px solid #ced4da; border-radius: 6px; padding: 12px;"></div>
          </div>
        </div>
        <button id="card-submit" class="btn btn-primary w-100" style="height: 45px; border-radius: 6px;">
          {% if current_lang == 'he' %}אישור תשלום{% elif current_lang == 'en' %}Confirm Payment{% else %}Подтвердить оплату{% endif %}
        </button>
      </div>
      
      <div id="paypal-button-container"></div>
      
      <button id="show-card-form" class="btn btn-outline-secondary w-100 mt-3" style="display: none;">
        <i class="bi bi-credit-card me-2"></i>
        {% if current_lang == 'he' %}שלם באמצעות כרטיס אשראי{% elif current_lang == 'en' %}Pay with Credit Card{% else %}Оплатить картой{% endif %}
      </button>
      
      <div id="payment-status" class="text-center mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{% if current_lang == 'he' %}מעבד תשלום...{% elif current_lang == 'en' %}Processing payment...{% else %}Обработка платежа...{% endif %}</span>
        </div>
        <p class="mt-2 text-muted">{% if current_lang == 'he' %}מעבד את התשלום...{% elif current_lang == 'en' %}Processing payment...{% else %}Обработка платежа...{% endif %}</p>
      </div>
      
      <p class="small text-muted text-center mt-3 mb-0">
        <i class="bi bi-lock me-1"></i>
        {% if current_lang == 'he' %}התשלום מאובטח ומוצפן באמצעות PayPal{% elif current_lang == 'en' %}Payment is secured and encrypted via PayPal{% else %}Оплата защищена и зашифрована через PayPal{% endif %}
      </p>
    </div>
  </div>
  {% else %}
  <!-- Fallback when PayPal not configured -->
  <div class="card mb-4">
    <div class="card-body text-center">
      <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(251,191,36,0.15); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
        <i class="bi bi-exclamation-triangle" style="font-size: 1.25rem; color: #fbbf24;"></i>
      </div>
      <h6>מערכת התשלום בהקמה</h6>
      <p class="text-muted small mb-3">PayPal עדיין לא מוגדר. צור קשר לפרטים נוספים.</p>
      <a href="{{ url_for('contact') }}" class="btn btn-outline-primary">
        <i class="bi bi-envelope me-2"></i> צור קשר
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Back Button -->
  <div class="text-center">
    <a href="{{ url_for('profile') }}" class="btn" style="background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px 24px;">
      <i class="bi bi-arrow-right me-2"></i> 
      {% if current_lang == 'he' %}חזרה לפרופיל{% elif current_lang == 'en' %}Back to Profile{% else %}Вернуться к профилю{% endif %}
    </a>
  </div>
</div>

{% if paypal_client_id and paypal_client_id != 'YOUR_PAYPAL_CLIENT_ID' %}
<!-- PayPal SDK with Subscriptions and Card Fields support -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD&vault=true&intent=subscription&enable-funding=card&components=buttons,card-fields"></script>
<script>
const plan = "{{ plan }}";

paypal.Buttons({
  style: {
    layout: 'vertical',
    color: 'blue',
    shape: 'rect',
    label: 'pay',
    height: 45
  },
  
  // Create subscription on server - returns subscription ID only, no redirect
  createSubscription: function(data, actions) {
    console.log('[PayPal] Creating subscription for plan:', plan);
    return fetch('/api/paypal/create-subscription-id', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ plan: plan })
    })
    .then(response => {
      console.log('[PayPal] Response status:', response.status);
      if (!response.ok) {
        return response.json().then(data => {
          console.error('[PayPal] Server error response:', data);
          throw new Error(data.error || 'Server error');
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('[PayPal] Response data:', data);
      if (data.error) {
        console.error('[PayPal] Error:', data.error);
        throw new Error(data.error);
      }
      // If payment not needed (credits cover it), redirect
      if (data.redirect) {
        console.log('[PayPal] Redirecting to:', data.redirect);
        window.location.href = data.redirect;
        return actions.reject();
      }
      if (!data.id) {
        console.error('[PayPal] No subscription ID in response');
        throw new Error('No subscription ID received');
      }
      console.log('[PayPal] Subscription created:', data.id);
      // Return subscription ID - PayPal SDK will handle the rest inline
      return data.id;
    })
    .catch(err => {
      console.error('[PayPal] Fetch error:', err);
      return Promise.reject(err);
    });
  },
  
  // Handle successful subscription approval (inline flow)
  onApprove: function(data, actions) {
    console.log('[PayPal] Subscription approved! ID:', data.subscriptionID);
    
    // Show loading state
    document.getElementById('payment-status').style.display = 'block';
    document.getElementById('paypal-button-container').style.display = 'none';
    
    // Activate subscription on server
    return fetch('/api/paypal/activate-subscription', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        subscription_id: data.subscriptionID,
        plan: plan
      })
    })
    .then(response => response.json())
    .then(result => {
      console.log('[PayPal] Activation result:', result);
      if (result.success) {
        window.location.href = result.redirect || '/subscribe-success?plan=' + plan;
      } else {
        throw new Error(result.error || 'Failed to activate subscription');
      }
    })
    .catch(err => {
      console.error('[PayPal] Activation error:', err);
      document.getElementById('payment-status').style.display = 'none';
      document.getElementById('paypal-button-container').style.display = 'block';
      alert('Error activating subscription. Please contact support.');
    });
  },
  
  onError: function(err) {
    console.error('PayPal Error:', err);
    console.error('Error details:', JSON.stringify(err, null, 2));
    const lang = "{{ current_lang }}";
    
    let errorMsg = '';
    if (err && err.message) {
      errorMsg = err.message;
    } else if (typeof err === 'string') {
      errorMsg = err;
    }
    
    const alertMsg = lang === 'he'
      ? 'שגיאה בתשלום: ' + (errorMsg || 'נסה שוב או צור קשר.')
      : lang === 'en'
      ? 'Payment error: ' + (errorMsg || 'Try again or contact us.')
      : 'Ошибка платежа: ' + (errorMsg || 'Попробуйте снова или свяжитесь с нами.');
    alert(alertMsg);
  },
  
  onCancel: function(data) {
    console.log('Payment cancelled');
  }
}).render('#paypal-button-container');

// Initialize Card Fields for inline card payment
if (paypal.CardFields) {
  const cardFields = paypal.CardFields({
    createSubscription: function(data, actions) {
      console.log('[CardFields] Creating subscription for plan:', plan);
      return fetch('/api/paypal/create-subscription-id', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ plan: plan })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.redirect) {
          window.location.href = data.redirect;
          return null;
        }
        if (data.id) {
          return data.id;
        }
        throw new Error('No subscription ID received');
      });
    },
    onApprove: function(data) {
      console.log('[CardFields] Subscription approved:', data.subscriptionID);
      // Activate subscription on server
      return fetch('/api/paypal/activate-subscription', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          subscription_id: data.subscriptionID,
          plan: plan
        })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          window.location.href = result.redirect || '/subscribe-success?plan=' + plan;
        } else {
          throw new Error(result.error || 'Failed to activate');
        }
      });
    },
    onError: function(err) {
      console.error('[CardFields] Error:', err);
      const lang = "{{ current_lang }}";
      const alertMsg = lang === 'he'
        ? 'שגיאה בתשלום בכרטיס. נסה שוב.'
        : lang === 'en'
        ? 'Card payment error. Try again.'
        : 'Ошибка оплаты картой. Попробуйте снова.';
      alert(alertMsg);
    }
  });

  // Check if card fields are eligible
  if (cardFields.isEligible()) {
    console.log('[CardFields] Card fields are eligible');
    
    // Render card fields
    cardFields.NumberField().render('#card-number');
    cardFields.ExpiryField().render('#card-expiry');
    cardFields.CVVField().render('#card-cvv');
    
    // Show card form and button
    document.getElementById('card-form').style.display = 'block';
    document.getElementById('show-card-form').style.display = 'block';
    
    // Handle submit button
    document.getElementById('card-submit').addEventListener('click', function() {
      console.log('[CardFields] Submit button clicked');
      cardFields.submit();
    });
    
    // Toggle between PayPal buttons and card form
    document.getElementById('show-card-form').addEventListener('click', function() {
      const cardForm = document.getElementById('card-form');
      const paypalButtons = document.getElementById('paypal-button-container');
      if (cardForm.style.display === 'none') {
        cardForm.style.display = 'block';
        paypalButtons.style.display = 'none';
        this.textContent = this.textContent.replace('Credit Card', 'PayPal').replace('כרטיס אשראי', 'PayPal').replace('картой', 'PayPal');
      } else {
        cardForm.style.display = 'none';
        paypalButtons.style.display = 'block';
        const lang = "{{ current_lang }}";
        this.innerHTML = '<i class="bi bi-credit-card me-2"></i>' + 
          (lang === 'he' ? 'שלם באמצעות כרטיס אשראי' : 
           lang === 'en' ? 'Pay with Credit Card' : 
           'Оплатить картой');
      }
    });
  } else {
    console.log('[CardFields] Card fields are NOT eligible - will use redirect flow');
  }
} else {
  console.log('[CardFields] CardFields not available in SDK');
}

</script>
{% endif %}
{% endblock %}

