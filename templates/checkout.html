{% extends "base.html" %}
{% block content %}
<div class="container my-5" style="max-width: 600px;">
  
  <!-- Header -->
  <div class="text-center mb-4">
    <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, {% if plan == 'pro' %}#10b981, #34d399{% else %}#2ea0ff, #34c3ff{% endif %}); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px {% if plan == 'pro' %}rgba(16,185,129,0.3){% else %}rgba(46,160,255,0.3){% endif %};">
      <i class="bi bi-{% if plan == 'pro' %}rocket-takeoff{% else %}star{% endif %}" style="font-size: 1.75rem; color: #fff;"></i>
    </div>
    <h2 style="color: #fff;">{% if current_lang == 'he' %}תשלום עבור {{ plan|upper }}{% elif current_lang == 'en' %}Payment for {{ plan|upper }}{% else %}Оплата за {{ plan|upper }}{% endif %}</h2>
    <p class="text-muted">{% if current_lang == 'he' %}מנוי חודשי ל-OnePoweb{% elif current_lang == 'en' %}Monthly subscription to OnePoweb{% else %}Месячная подписка на OnePoweb{% endif %}</p>
  </div>

  <!-- Order Summary -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="mb-4">
        <i class="bi bi-receipt me-2" style="color: #2ea0ff;"></i>
        {{ t('checkout_order_summary') }}
      </h5>
      
      <div class="d-flex justify-content-between mb-2">
        <span>{% if current_lang == 'he' %}חבילת {{ plan|upper }} (חודשי){% elif current_lang == 'en' %}{{ plan|upper }} Plan (Monthly){% else %}План {{ plan|upper }} (Месячный){% endif %}</span>
        <span>${{ base_price_usd }}</span>
      </div>
      
      {% if referral_discount > 0 %}
      <div class="d-flex justify-content-between mb-2" style="color: #34d399;">
        <span><i class="bi bi-gift me-1"></i> {% if current_lang == 'he' %}הנחת רפרל ({{ referral_discount }}%){% elif current_lang == 'en' %}Referral Discount ({{ referral_discount }}%){% else %}Реферальная скидка ({{ referral_discount }}%){% endif %}</span>
        <span>-${{ discount_usd }}</span>
      </div>
      <div class="small text-muted mb-2">
        <i class="bi bi-info-circle me-1"></i> {% if current_lang == 'he' %}הנחה חד-פעמית מהזמנת חבר{% elif current_lang == 'en' %}One-time discount from friend's order{% else %}Одноразовая скидка от заказа друга{% endif %}
      </div>
      {% endif %}
      
      <hr style="border-color: var(--border);">
      
      <div class="d-flex justify-content-between" style="font-size: 1.25rem; font-weight: bold;">
        <span>{% if current_lang == 'he' %}סה"כ לתשלום{% elif current_lang == 'en' %}Total to Pay{% else %}Итого к оплате{% endif %}</span>
        <span style="color: {% if plan == 'pro' %}#34d399{% else %}#34c3ff{% endif %};">
          ${{ net_price_usd }}
        </span>
      </div>
    </div>
  </div>

  <!-- Plan Features -->
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">{% if current_lang == 'he' %}מה כלול בחבילה:{% elif current_lang == 'en' %}What's included in the plan:{% else %}Что включено в план:{% endif %}</h6>
      <ul class="list-unstyled mb-0">
        {% if plan == 'pro' %}
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}ניתוחים ללא הגבלה{% elif current_lang == 'en' %}Unlimited analyses{% else %}Неограниченные анализы{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}גרפים מתקדמים{% elif current_lang == 'en' %}Advanced graphs{% else %}Продвинутые графики{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}ייצוא PDF מותאם{% elif current_lang == 'en' %}Custom PDF export{% else %}Настраиваемый экспорт PDF{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}תובנות AI מותאמות אישית{% elif current_lang == 'en' %}Personalized AI insights{% else %}Персонализированные AI-инсайты{% endif %}</li>
        <li class="mb-0"><i class="bi bi-check-circle-fill me-2" style="color: #34d399;"></i> {% if current_lang == 'he' %}תמיכה עדיפות{% elif current_lang == 'en' %}Priority support{% else %}Приоритетная поддержка{% endif %}</li>
        {% else %}
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}עד 50 ניתוחים בחודש{% elif current_lang == 'en' %}Up to 50 analyses per month{% else %}До 50 анализов в месяц{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}גרפים בסיסיים{% elif current_lang == 'en' %}Basic graphs{% else %}Базовые графики{% endif %}</li>
        <li class="mb-2"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}ייצוא PDF{% elif current_lang == 'en' %}PDF export{% else %}Экспорт PDF{% endif %}</li>
        <li class="mb-0"><i class="bi bi-check-circle-fill me-2" style="color: #34c3ff;"></i> {% if current_lang == 'he' %}תמיכה באימייל{% elif current_lang == 'en' %}Email support{% else %}Поддержка по email{% endif %}</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <!-- PayPal Button Container -->
  {% if paypal_client_id and paypal_client_id != 'YOUR_PAYPAL_CLIENT_ID' %}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">
        <i class="bi bi-shield-check me-2" style="color: #34d399;"></i>
        {% if current_lang == 'he' %}תשלום מאובטח{% elif current_lang == 'en' %}Secure Payment{% else %}Безопасная оплата{% endif %}
      </h6>
      
      <div id="paypal-button-container"></div>
      
      <div id="payment-status" class="text-center mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{% if current_lang == 'he' %}מעבד תשלום...{% elif current_lang == 'en' %}Processing payment...{% else %}Обработка платежа...{% endif %}</span>
        </div>
        <p class="mt-2 text-muted">{% if current_lang == 'he' %}מעבד את התשלום...{% elif current_lang == 'en' %}Processing payment...{% else %}Обработка платежа...{% endif %}</p>
      </div>
      
      <p class="small text-muted text-center mt-3 mb-0">
        <i class="bi bi-lock me-1"></i>
        {% if current_lang == 'he' %}התשלום מאובטח ומוצפן באמצעות PayPal{% elif current_lang == 'en' %}Payment is secured and encrypted via PayPal{% else %}Оплата защищена и зашифрована через PayPal{% endif %}
      </p>
    </div>
  </div>
  {% else %}
  <!-- Fallback when PayPal not configured -->
  <div class="card mb-4">
    <div class="card-body text-center">
      <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(251,191,36,0.15); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
        <i class="bi bi-exclamation-triangle" style="font-size: 1.25rem; color: #fbbf24;"></i>
      </div>
      <h6>מערכת התשלום בהקמה</h6>
      <p class="text-muted small mb-3">PayPal עדיין לא מוגדר. צור קשר לפרטים נוספים.</p>
      <a href="{{ url_for('contact') }}" class="btn btn-outline-primary">
        <i class="bi bi-envelope me-2"></i> צור קשר
      </a>
    </div>
  </div>
  {% endif %}

  <!-- Back Button -->
  <div class="text-center">
    <a href="{{ url_for('profile') }}" class="btn" style="background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px 24px;">
      <i class="bi bi-arrow-right me-2"></i> חזרה לפרופיל
    </a>
  </div>
</div>

{% if paypal_client_id and paypal_client_id != 'YOUR_PAYPAL_CLIENT_ID' %}
<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>
<script>
const plan = "{{ plan }}";

paypal.Buttons({
  style: {
    layout: 'vertical',
    color: 'blue',
    shape: 'rect',
    label: 'pay',
    height: 45
  },
  
  // Create order on server
  createOrder: function(data, actions) {
    console.log('[PayPal] Creating order for plan:', plan);
    return fetch('/api/paypal/create-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ plan: plan })
    })
    .then(response => {
      console.log('[PayPal] Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('[PayPal] Response data:', data);
      if (data.error) {
        console.error('[PayPal] Error:', data.error);
        throw new Error(data.error);
      }
      // If payment not needed (credits cover it), redirect
      if (data.redirect) {
        window.location.href = data.redirect;
        return null;
      }
      console.log('[PayPal] Order created:', data.id);
      return data.id;
    })
    .catch(err => {
      console.error('[PayPal] Fetch error:', err);
      throw err;
    });
  },
  
  // Capture payment on server
  onApprove: function(data, actions) {
    document.getElementById('paypal-button-container').style.display = 'none';
    document.getElementById('payment-status').style.display = 'block';
    
    return fetch('/api/paypal/capture-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ orderID: data.orderID })
    })
    .then(response => {
      console.log('[PayPal] Capture response status:', response.status);
      console.log('[PayPal] Capture response ok:', response.ok);
      if (!response.ok) {
        return response.json().then(err => {
          console.error('[PayPal] Capture error response:', err);
          return Promise.reject(err);
        }).catch(() => {
          // If JSON parsing fails, return generic error
          return Promise.reject({error: `HTTP ${response.status}: ${response.statusText}`});
        });
      }
      return response.json().catch(err => {
        console.error('[PayPal] Failed to parse JSON:', err);
        return Promise.reject({error: 'Invalid response from server'});
      });
    })
    .then(result => {
      console.log('[PayPal] Capture result:', result);
      if (result.success && result.redirect) {
        console.log('[PayPal] Payment successful, redirecting to:', result.redirect);
        window.location.href = result.redirect;
      } else {
        const errorMsg = result.error || 'Unknown error';
        console.error('[PayPal] Capture error:', errorMsg);
        console.error('[PayPal] Full result:', JSON.stringify(result, null, 2));
        const lang = "{{ current_lang }}";
        let alertMsg;
        if (lang === 'he') {
          alertMsg = 'שגיאה בעיבוד התשלום: ' + errorMsg + '\n\nאנא נסה שוב או צור קשר לתמיכה.';
        } else if (lang === 'en') {
          alertMsg = 'Payment processing error: ' + errorMsg + '\n\nPlease try again or contact support.';
        } else {
          alertMsg = 'Ошибка обработки платежа: ' + errorMsg + '\n\nПопробуйте снова или свяжитесь с поддержкой.';
        }
        alert(alertMsg);
        document.getElementById('paypal-button-container').style.display = 'block';
        document.getElementById('payment-status').style.display = 'none';
      }
    })
    .catch(err => {
      console.error('[PayPal] Capture fetch error:', err);
      const lang = "{{ current_lang }}";
      const alertMsg = lang === 'he'
        ? 'שגיאה בעיבוד התשלום. נסה שוב או צור קשר.'
        : lang === 'en'
        ? 'Payment processing error. Try again or contact us.'
        : 'Ошибка обработки платежа. Попробуйте снова или свяжитесь с нами.';
      alert(alertMsg);
      document.getElementById('paypal-button-container').style.display = 'block';
      document.getElementById('payment-status').style.display = 'none';
    });
  },
  
  onError: function(err) {
    console.error('PayPal Error:', err);
    const lang = "{{ current_lang }}";
    const alertMsg = lang === 'he'
      ? 'שגיאה בתשלום. נסה שוב או צור קשר.'
      : lang === 'en'
      ? 'Payment error. Try again or contact us.'
      : 'Ошибка платежа. Попробуйте снова или свяжитесь с нами.';
    alert(alertMsg);
  },
  
  onCancel: function(data) {
    console.log('Payment cancelled');
  }
}).render('#paypal-button-container');
</script>
{% endif %}
{% endblock %}

