{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <!-- ×›×•×ª×¨×ª -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1" style="text-decoration: none !important;">ğŸ“Š {{ t('dashboard_title') }}</h2>
      <p class="text-muted mb-0">{{ t('dashboard_subtitle') }}</p>
    </div>
    <a class="btn btn-primary" href="{{ url_for('index') }}">
      <i class="bi bi-plus-lg"></i> {{ t('dashboard_upload_new') }}
    </a>
  </div>

  <!-- ×›×¨×˜×™×¡×™ ×¡×™×›×•× -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white shadow h-100">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 opacity-75" style="text-decoration: none;">{{ t('dashboard_total_sales') }}</h6>
          <h2 class="card-title mb-0" style="text-decoration: none !important;">{{ total_sales_currency_symbol if total_sales_currency_symbol else currency_symbol }}{{ "{:,.0f}".format(total_sales) }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white shadow h-100">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 opacity-75" style="text-decoration: none;">{{ t('dashboard_saved_reports') }}</h6>
          <h2 class="card-title mb-0" style="text-decoration: none !important;">{{ total_reports }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white shadow h-100">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 opacity-75" style="text-decoration: none;">{{ t('dashboard_avg_daily') }}</h6>
          <h2 class="card-title mb-0" style="text-decoration: none !important;">{{ currency_symbol }}{{ "{:,.0f}".format(latest_summary.get('avg_daily', 0)) }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow h-100" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border: none;">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 opacity-75" style="color: rgba(255,255,255,0.9); text-decoration: none;">{{ t('dashboard_plan') }}</h6>
          {% if user.plan|upper == 'PRO' %}
          <div class="d-inline-flex align-items-center justify-content-center gap-2 px-4 py-2 rounded-pill" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <i class="bi bi-rocket-takeoff" style="font-size: 1.2rem; color: #fff;"></i>
            <h2 class="card-title mb-0" style="color: #fff; font-weight: 700; text-decoration: none; letter-spacing: 1px;">PRO</h2>
            <i class="bi bi-star-fill" style="font-size: 0.9rem; color: #fbbf24;"></i>
          </div>
          {% else %}
          <h2 class="card-title mb-0" style="color: #fff; text-decoration: none;">{{ user.plan|upper }}</h2>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if comparison %}
  <!-- ×”×©×•×•××ª ×ª×§×•×¤×•×ª ××•×˜×•××˜×™×ª - Enhanced -->
  {% set comp_currency_symbol = (comparison_currency.symbol if comparison_currency else currency_symbol) %}
  <div class="card shadow-sm mb-4" style="border: none; border-radius: 16px; overflow: hidden;">
    <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
      <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">ğŸ“ˆ {% if current_lang == 'he' %}×”×©×•×•××” ××•×˜×•××˜×™×ª: {{ comparison.get('report2_name', '××—×¨×•×Ÿ') }} ××•×œ {{ comparison.get('report1_name', '×§×•×“×') }}{% elif current_lang == 'en' %}Automatic Comparison: {{ comparison.get('report2_name', 'Latest') }} vs {{ comparison.get('report1_name', 'Previous') }}{% else %}ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ: {{ comparison.get('report2_name', 'ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹') }} vs {{ comparison.get('report1_name', 'ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹') }}{% endif %}</h5>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#detailedComparison">
          <i class="bi bi-chevron-down"></i> {% if current_lang == 'he' %}×¤×¨×˜×™×{% elif current_lang == 'en' %}Details{% else %}ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ{% endif %}
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Main Comparison -->
      <div class="row g-4">
        <!-- ×ª×§×•×¤×” ×§×•×“××ª -->
        <div class="col-md-5">
          <div class="border rounded-3 p-3 bg-light h-100">
            <h6 class="text-muted mb-2">{{ comparison.get('report1_name', ('×ª×§×•×¤×” ×§×•×“××ª' if current_lang == 'he' else 'Previous Period' if current_lang == 'en' else 'ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´')) }}</h6>
            <p class="h3 mb-1 text-primary">{{ comp_currency_symbol }}{{ "{:,.0f}".format(comparison.period1.total) }}</p>
            <div class="d-flex flex-wrap gap-2 text-muted small">
              <span><i class="bi bi-calendar"></i> {{ comparison.period1.days }} {% if current_lang == 'he' %}×™××™×{% elif current_lang == 'en' %}days{% else %}Ğ´Ğ½ĞµĞ¹{% endif %}</span>
              <span><i class="bi bi-receipt"></i> {{ comparison.period1.transactions }} {% if current_lang == 'he' %}×¢×¡×§××•×ª{% elif current_lang == 'en' %}trans.{% else %}Ñ‚Ñ€Ğ°Ğ½Ğ·.{% endif %}</span>
              <span><i class="bi bi-cart"></i> {{ comp_currency_symbol }}{{ "{:,.0f}".format(comparison.period1.avg_ticket|default(0)) }} {% if current_lang == 'he' %}×××•×¦×¢{% elif current_lang == 'en' %}avg{% else %}ÑÑ€ĞµĞ´Ğ½.{% endif %}</span>
            </div>
          </div>
        </div>
        
        <!-- ×—×¥ ×”×©×•×•××” -->
        <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
          <i class="bi bi-arrow-left-right fs-3 text-muted mb-2"></i>
          {% if comparison.changes.total_pct > 0 %}
            <span class="badge bg-success fs-5 px-3 py-2" style="border-radius: 12px;">â†‘ {{ comparison.changes.total_pct }}%</span>
          {% elif comparison.changes.total_pct < 0 %}
            <span class="badge bg-danger fs-5 px-3 py-2" style="border-radius: 12px;">â†“ {{ comparison.changes.total_pct|abs }}%</span>
          {% else %}
            <span class="badge bg-secondary fs-5 px-3 py-2" style="border-radius: 12px;">= 0%</span>
          {% endif %}
        </div>
        
        <!-- ×ª×§×•×¤×” × ×•×›×—×™×ª -->
        <div class="col-md-5">
          <div class="border rounded-3 p-3 h-100" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
            <h6 class="text-dark mb-2" style="color: #2d5016 !important;">{{ comparison.get('report2_name', ('×ª×§×•×¤×” ××—×¨×•× ×”' if current_lang == 'he' else 'Latest Period' if current_lang == 'en' else 'ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´')) }}</h6>
            <p class="h3 mb-1" style="color: #1b5e20 !important; font-weight: 700;">{{ comp_currency_symbol }}{{ "{:,.0f}".format(comparison.period2.total) }}</p>
            <div class="d-flex flex-wrap gap-2 small" style="color: #2d5016 !important;">
              <span><i class="bi bi-calendar"></i> {{ comparison.period2.days }} {% if current_lang == 'he' %}×™××™×{% elif current_lang == 'en' %}days{% else %}Ğ´Ğ½ĞµĞ¹{% endif %}</span>
              <span><i class="bi bi-receipt"></i> {{ comparison.period2.transactions }} {% if current_lang == 'he' %}×¢×¡×§××•×ª{% elif current_lang == 'en' %}trans.{% else %}Ñ‚Ñ€Ğ°Ğ½Ğ·.{% endif %}</span>
              <span><i class="bi bi-cart"></i> {{ comp_currency_symbol }}{{ "{:,.0f}".format(comparison.period2.avg_ticket|default(0)) }} {% if current_lang == 'he' %}×××•×¦×¢{% elif current_lang == 'en' %}avg{% else %}ÑÑ€ĞµĞ´Ğ½.{% endif %}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ×ª×•×‘× ×” -->
      <div class="alert alert-info mt-3 mb-0" style="border-radius: 12px; border: none; background: rgba(46,160,255,0.1);">
        <i class="bi bi-lightbulb"></i> {{ comparison.insight }}
      </div>
      
      <!-- Detailed Comparison (Collapsible) -->
      <div class="collapse mt-4" id="detailedComparison">
        
        <!-- KPI Cards -->
        <div class="row g-3 mb-4">
          <div class="col-6 col-md-3">
            <div class="text-center p-3 rounded-3" style="background: rgba(16,185,129,0.08);">
              <div class="small text-muted">{% if current_lang == 'he' %}×©×™× ×•×™ ×™×•××™{% elif current_lang == 'en' %}Daily Change{% else %}Ğ˜Ğ·Ğ¼. Ğ² Ğ´ĞµĞ½ÑŒ{% endif %}</div>
              <div class="h5 mb-0 {{ 'text-success' if comparison.changes.avg_daily_pct > 0 else 'text-danger' if comparison.changes.avg_daily_pct < 0 else '' }}">
                {{ '+' if comparison.changes.avg_daily_pct > 0 else '' }}{{ comparison.changes.avg_daily_pct }}%
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-3 rounded-3" style="background: rgba(46,160,255,0.08);">
              <div class="small text-muted">{% if current_lang == 'he' %}×©×™× ×•×™ ×‘×¢×¡×§××•×ª{% elif current_lang == 'en' %}Transaction Change{% else %}Ğ˜Ğ·Ğ¼. Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹{% endif %}</div>
              <div class="h5 mb-0 {{ 'text-success' if comparison.changes.transactions_pct > 0 else 'text-danger' if comparison.changes.transactions_pct < 0 else '' }}">
                {{ '+' if comparison.changes.transactions_pct > 0 else '' }}{{ comparison.changes.transactions_pct }}%
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-3 rounded-3" style="background: rgba(251,191,36,0.08);">
              <div class="small text-muted">{% if current_lang == 'he' %}×©×™× ×•×™ ×‘×××•×¦×¢{% elif current_lang == 'en' %}Avg Ticket Change{% else %}Ğ˜Ğ·Ğ¼. ÑÑ€. Ñ‡ĞµĞºĞ°{% endif %}</div>
              <div class="h5 mb-0 {{ 'text-success' if comparison.changes.avg_ticket_pct|default(0) > 0 else 'text-danger' if comparison.changes.avg_ticket_pct|default(0) < 0 else '' }}">
                {{ '+' if comparison.changes.avg_ticket_pct|default(0) > 0 else '' }}{{ comparison.changes.avg_ticket_pct|default(0) }}%
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="text-center p-3 rounded-3" style="background: rgba(139,92,246,0.08);">
              <div class="small text-muted">{% if current_lang == 'he' %}×”×¤×¨×© ××•×—×œ×˜{% elif current_lang == 'en' %}Absolute Diff{% else %}ĞĞ±Ñ. Ñ€Ğ°Ğ·Ğ½Ğ¸Ñ†Ğ°{% endif %}</div>
              <div class="h5 mb-0 {{ 'text-success' if (comparison.period2.total - comparison.period1.total) > 0 else 'text-danger' }}">
                {{ '+' if (comparison.period2.total - comparison.period1.total) > 0 else '' }}{{ comp_currency_symbol }}{{ "{:,.0f}".format(comparison.period2.total - comparison.period1.total) }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Weekday Comparison -->
        {% if comparison.weekday_comparison %}
        <div class="card mb-4" style="border: 1px solid rgba(102,126,234,0.2); border-radius: 12px;">
          <div class="card-header bg-transparent" style="border-bottom: 1px solid rgba(102,126,234,0.1);">
            <h6 class="mb-0"><i class="bi bi-calendar-week me-2"></i>{% if current_lang == 'he' %}×”×©×•×•××” ×œ×¤×™ ×™××™×{% elif current_lang == 'en' %}Comparison by Day{% else %}Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼{% endif %}</h6>
          </div>
          <div class="card-body">
            <div class="row g-2">
              {% for day, data in comparison.weekday_comparison.items() %}
              <div class="col-6 col-md-3 col-lg">
                <div class="text-center p-2 rounded-3" style="background: rgba(102,126,234,0.05); border: 1px solid rgba(102,126,234,0.1);">
                  <div class="small fw-semibold mb-1">{{ day }}</div>
                  <div class="small {{ 'text-success' if data.change_pct > 0 else 'text-danger' if data.change_pct < 0 else 'text-muted' }}">
                    {% if data.change_pct > 0 %}â†‘{% elif data.change_pct < 0 %}â†“{% else %}={% endif %} {{ data.change_pct|abs }}%
                  </div>
                  <div class="small text-muted">{{ comp_currency_symbol }}{{ "{:,.0f}".format(data.period2) }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Best & Worst Days -->
        {% if comparison.best_day or comparison.worst_day %}
        <div class="row g-3 mb-4">
          {% if comparison.best_day %}
          <div class="col-md-6">
            <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(34,197,94,0.05)); border: 1px solid rgba(16,185,129,0.2);">
              <div class="d-flex align-items-center gap-2">
                <div style="width: 40px; height: 40px; background: rgba(16,185,129,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-trophy text-success"></i>
                </div>
                <div>
                  <div class="small text-muted">{% if current_lang == 'he' %}×”×™×•× ×”×›×™ ×˜×•×‘{% elif current_lang == 'en' %}Best Day{% else %}Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ{% endif %}</div>
                  <div class="fw-bold">{{ comparison.best_day.name }} <span class="text-success">+{{ comparison.best_day.data.change_pct }}%</span></div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% if comparison.worst_day %}
          <div class="col-md-6">
            <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(248,113,113,0.05)); border: 1px solid rgba(239,68,68,0.2);">
              <div class="d-flex align-items-center gap-2">
                <div style="width: 40px; height: 40px; background: rgba(239,68,68,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-exclamation-triangle text-danger"></i>
                </div>
                <div>
                  <div class="small text-muted">{% if current_lang == 'he' %}×”×™×•× ×”×›×™ ×—×œ×©{% elif current_lang == 'en' %}Weakest Day{% else %}Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ{% endif %}</div>
                  <div class="fw-bold">{{ comparison.worst_day.name }} <span class="text-danger">{{ comparison.worst_day.data.change_pct }}%</span></div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        <!-- Peak Hours -->
        {% if comparison.peak_hours and comparison.peak_hours.period2 %}
        <div class="card mb-4" style="border: 1px solid rgba(251,191,36,0.2); border-radius: 12px;">
          <div class="card-header bg-transparent" style="border-bottom: 1px solid rgba(251,191,36,0.1);">
            <h6 class="mb-0"><i class="bi bi-clock me-2"></i>{% if current_lang == 'he' %}×©×¢×•×ª ×©×™×{% elif current_lang == 'en' %}Peak Hours{% else %}ĞŸĞ¸ĞºĞ¾Ğ²Ñ‹Ğµ Ñ‡Ğ°ÑÑ‹{% endif %}</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="small text-muted mb-2">{% if current_lang == 'he' %}×ª×§×•×¤×” ×§×•×“××ª{% elif current_lang == 'en' %}Previous Period{% else %}ĞŸÑ€Ğ¾ÑˆĞ»Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´{% endif %}</div>
                {% for ph in comparison.peak_hours.period1[:3] %}
                <div class="d-flex justify-content-between align-items-center mb-1 p-2 rounded" style="background: rgba(0,0,0,0.02);">
                  <span><i class="bi bi-clock me-1"></i>{{ ph.hour }}</span>
                  <span class="fw-semibold">{{ comp_currency_symbol }}{{ "{:,.0f}".format(ph.total) }}</span>
                </div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <div class="small text-muted mb-2">{% if current_lang == 'he' %}×ª×§×•×¤×” × ×•×›×—×™×ª{% elif current_lang == 'en' %}Current Period{% else %}Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´{% endif %}</div>
                {% for ph in comparison.peak_hours.period2[:3] %}
                <div class="d-flex justify-content-between align-items-center mb-1 p-2 rounded" style="background: rgba(16,185,129,0.05);">
                  <span><i class="bi bi-clock me-1"></i>{{ ph.hour }}</span>
                  <span class="fw-semibold text-success">{{ comp_currency_symbol }}{{ "{:,.0f}".format(ph.total) }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Top Products Comparison -->
        {% if comparison.top_products and comparison.top_products.period2 %}
        <div class="card" style="border: 1px solid rgba(139,92,246,0.2); border-radius: 12px;">
          <div class="card-header bg-transparent" style="border-bottom: 1px solid rgba(139,92,246,0.1);">
            <h6 class="mb-0"><i class="bi bi-star me-2"></i>{% if current_lang == 'he' %}××•×¦×¨×™× ××•×‘×™×œ×™×{% elif current_lang == 'en' %}Top Products{% else %}Ğ¢Ğ¾Ğ¿ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²{% endif %}</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="small text-muted mb-2">{% if current_lang == 'he' %}×ª×§×•×¤×” ×§×•×“××ª{% elif current_lang == 'en' %}Previous Period{% else %}ĞŸÑ€Ğ¾ÑˆĞ»Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´{% endif %}</div>
                {% for prod in comparison.top_products.period1[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-1 p-2 rounded" style="background: rgba(0,0,0,0.02);">
                  <span class="text-truncate me-2" style="max-width: 150px;">{{ prod.name }}</span>
                  <span class="fw-semibold">{{ comp_currency_symbol }}{{ "{:,.0f}".format(prod.total) }}</span>
                </div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <div class="small text-muted mb-2">{% if current_lang == 'he' %}×ª×§×•×¤×” × ×•×›×—×™×ª{% elif current_lang == 'en' %}Current Period{% else %}Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´{% endif %}</div>
                {% for prod in comparison.top_products.period2[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-1 p-2 rounded" style="background: rgba(139,92,246,0.05);">
                  <span class="text-truncate me-2" style="max-width: 150px;">{{ prod.name }}</span>
                  <span class="fw-semibold" style="color: #8b5cf6;">{{ comp_currency_symbol }}{{ "{:,.0f}".format(prod.total) }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ×ª×§×•×¤×” -->
  <div class="card shadow-sm mb-4">
    <div class="card-body py-2">
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <span class="text-muted me-2">{% if current_lang == 'he' %}×¡× ×Ÿ ×œ×¤×™:{% elif current_lang == 'en' %}Filter by:{% else %}Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾:{% endif %}</span>
        <a href="{{ url_for('dashboard') }}" 
           class="btn btn-sm {{ 'btn-primary' if not filter_type else 'btn-outline-secondary' }}">
          {% if current_lang == 'he' %}×”×›×œ{% elif current_lang == 'en' %}All{% else %}Ğ’ÑĞµ{% endif %} ({{ reports|length }})
        </a>
        {% for type_key, type_label in period_type_labels.items() %}
          {% set count = reports_by_type.get(type_key, [])|length %}
          {% if count > 0 %}
          <a href="{{ url_for('dashboard', period_type=type_key) }}" 
             class="btn btn-sm {{ 'btn-primary' if filter_type == type_key else 'btn-outline-secondary' }}">
            {{ type_label }} ({{ count }})
          </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ×¨×©×™××ª ×“×•×—×•×ª -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0" style="text-decoration: none !important;">ğŸ“ {% if current_lang == 'he' %}×”×“×•×—×•×ª ×©×œ×™{% elif current_lang == 'en' %}My Reports{% else %}ĞœĞ¾Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹{% endif %}</h5>
      {% if reports|length >= 2 %}
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#compareModal">
        <i class="bi bi-bar-chart"></i> {% if current_lang == 'he' %}×”×©×•×•×” ×ª×§×•×¤×•×ª{% elif current_lang == 'en' %}Compare Periods{% else %}Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹{% endif %}
      </button>
      {% endif %}
    </div>
    <div class="card-body p-0">
      {% if reports %}
      <div class="table-responsive">
        <table class="table table-hover mb-0 reports-table">
          <thead>
            <tr>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}×©× ×”×“×•×—{% elif current_lang == 'en' %}Report Name{% else %}ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°{% endif %}</th>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}×¡×•×’{% elif current_lang == 'en' %}Type{% else %}Ğ¢Ğ¸Ğ¿{% endif %}</th>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}×ª×§×•×¤×”{% elif current_lang == 'en' %}Period{% else %}ĞŸĞµÑ€Ğ¸Ğ¾Ğ´{% endif %}</th>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}×¡×”"×› ××›×™×¨×•×ª{% elif current_lang == 'en' %}Total Sales{% else %}ĞĞ±Ñ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸{% endif %}</th>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}×××•×¦×¢ ×™×•××™{% elif current_lang == 'en' %}Daily Avg{% else %}Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ¹{% endif %}</th>
              <th style="text-decoration: none !important;">{% if current_lang == 'he' %}× ×•×¦×¨{% elif current_lang == 'en' %}Created{% else %}Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½{% endif %}</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            {% set summary = report.summary_json | fromjson if report.summary_json else {} %}
            <tr>
              <td><strong style="text-decoration: none;">{{ report.name }}</strong></td>
              <td>
                {% set pt = report.get('period_type', 'month') %}
                {% if pt == 'month' %}
                  <span class="badge bg-primary">{{ t('month') }}</span>
                {% elif pt == 'week' %}
                  <span class="badge bg-success">{{ t('week') }}</span>
                {% elif pt == 'day' %}
                  <span class="badge bg-info">{{ t('day') }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ t('custom') }}</span>
                {% endif %}
              </td>
              <td>
                {% if report.period_start and report.period_end %}
                  <small>{{ report.period_start }} â†’ {{ report.period_end }}</small>
                {% else %}
                  â€”
                {% endif %}
              </td>
              {% set report_currency_code = report.get('currency') or 'USD' %}
              {% set report_currency_info = get_currency_by_code(report_currency_code) %}
              {% set report_currency_symbol = report_currency_info.symbol %}
              <td><strong style="text-decoration: none !important;">{{ report_currency_symbol }}{{ "{:,.0f}".format(summary.get('total_sales', 0)) }}</strong></td>
              <td>{{ report_currency_symbol }}{{ "{:,.0f}".format(summary.get('avg_daily', 0)) }}</td>
              <td><small>{{ report.created_at[:10] if report.created_at else 'â€”' }}</small></td>
              <td>
                <form method="POST" action="{{ url_for('dashboard_delete_report', report_id=report.id) }}" 
                      onsubmit="return confirm('{% if current_lang == 'he' %}×œ××—×•×§ ××ª ×”×“×•×—?{% elif current_lang == 'en' %}Delete this report?{% else %}Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ğ¾Ñ‚Ñ‡ĞµÑ‚?{% endif %}')" class="d-inline">
                  <button class="btn btn-outline-danger btn-sm" title="{{ t('delete') }}">ğŸ—‘ï¸</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5 text-muted">
        <h4 style="text-decoration: none !important;">{% if current_lang == 'he' %}××™×Ÿ ×“×•×—×•×ª ×©××•×¨×™× ×¢×“×™×™×Ÿ{% elif current_lang == 'en' %}No saved reports yet{% else %}ĞĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²{% endif %}</h4>
        <p>{% if current_lang == 'he' %}×”×¢×œ×” ××ª ×”×“×•×— ×”×¨××©×•×Ÿ ×©×œ×š ×•×›×œ ×”× ×™×ª×•×—×™× ×™×™×©××¨×• ××•×˜×•××˜×™×ª{% elif current_lang == 'en' %}Upload your first report and all analyses will be saved automatically{% else %}Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚, Ğ¸ Ğ²ÑĞµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸{% endif %}</p>
        <a class="btn btn-primary" href="{{ url_for('index') }}">{% if current_lang == 'he' %}×”×¢×œ×” ×“×•×—{% elif current_lang == 'en' %}Upload Report{% else %}Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡ĞµÑ‚{% endif %}</a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Quick Actions & Insights -->
  <div class="row g-4 mt-2 mb-4">
    <!-- Trend Indicator -->
    <div class="col-md-6">
      <div class="card h-100" style="border: none; border-radius: 16px; background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(34,197,94,0.02));">
        <div class="card-body">
          <h6 class="mb-3">
            <i class="bi bi-graph-up me-2" style="color: #10b981;"></i>
            {% if current_lang == 'he' %}××’××ª ×”××›×™×¨×•×ª{% elif current_lang == 'en' %}Sales Trend{% else %}Ğ¢Ñ€ĞµĞ½Ğ´ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶{% endif %}
          </h6>
          
          {% if reports|length >= 2 %}
            {% set trend_pct = ((latest_summary.get('total_sales', 0) - (reports[1].summary_json | fromjson if reports[1].summary_json else {}).get('total_sales', 1)) / ((reports[1].summary_json | fromjson if reports[1].summary_json else {}).get('total_sales', 1) or 1) * 100)|round|int %}
            <div class="d-flex align-items-center gap-3">
              <div style="width: 60px; height: 60px; border-radius: 50%; background: {{ 'rgba(16,185,129,0.15)' if trend_pct >= 0 else 'rgba(239,68,68,0.15)' }}; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-{{ 'arrow-up-right' if trend_pct >= 0 else 'arrow-down-right' }}" style="font-size: 1.8rem; color: {{ '#10b981' if trend_pct >= 0 else '#ef4444' }};"></i>
              </div>
              <div>
                <div class="h3 mb-0 {{ 'text-success' if trend_pct >= 0 else 'text-danger' }}">
                  {{ '+' if trend_pct >= 0 else '' }}{{ trend_pct }}%
                </div>
                <div class="small text-muted">{% if current_lang == 'he' %}××”×ª×§×•×¤×” ×”×§×•×“××ª{% elif current_lang == 'en' %}vs previous period{% else %}Ğº Ğ¿Ñ€ĞµĞ´. Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñƒ{% endif %}</div>
              </div>
            </div>
          {% else %}
            <div class="text-center py-3 text-muted">
              <i class="bi bi-info-circle me-1"></i>
              {% if current_lang == 'he' %}×”×¢×œ×” ×“×•×— × ×•×¡×£ ×œ×¨××•×ª ××’××•×ª{% elif current_lang == 'en' %}Upload another report to see trends{% else %}Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ĞµÑ‰Ñ‘ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ´Ğ»Ñ Ñ‚Ñ€ĞµĞ½Ğ´Ğ¾Ğ²{% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="col-md-6">
      <div class="card h-100" style="border: none; border-radius: 16px; background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(124,58,237,0.02));">
        <div class="card-body">
          <h6 class="mb-3">
            <i class="bi bi-lightning-charge me-2" style="color: #8b5cf6;"></i>
            {% if current_lang == 'he' %}×ª×•×‘× ×•×ª ××”×™×¨×•×ª{% elif current_lang == 'en' %}Quick Insights{% else %}Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ¸Ğ½ÑĞ°Ğ¹Ñ‚Ñ‹{% endif %}
          </h6>
          
          <div class="row g-2">
            <div class="col-6">
              <div class="p-2 rounded-3 text-center" style="background: rgba(139,92,246,0.08);">
                <div class="small text-muted">{% if current_lang == 'he' %}×“×•×—×•×ª ×”×—×•×“×©{% elif current_lang == 'en' %}Reports this month{% else %}ĞÑ‚Ñ‡ĞµÑ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†{% endif %}</div>
                <div class="h5 mb-0" style="color: #8b5cf6;">{{ total_reports }}</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 rounded-3 text-center" style="background: rgba(46,160,255,0.08);">
                <div class="small text-muted">{% if current_lang == 'he' %}×™××™× ×¢× × ×ª×•× ×™×{% elif current_lang == 'en' %}Days with data{% else %}Ğ”Ğ½ĞµĞ¹ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸{% endif %}</div>
                <div class="h5 mb-0" style="color: #2ea0ff;">{{ latest_summary.get('unique_days', latest_summary.get('days', 'â€”')) }}</div>
              </div>
            </div>
          </div>
          
          {% if latest_summary.get('peak_hour') or latest_summary.get('best_day') %}
          <div class="mt-2 p-2 rounded-3" style="background: rgba(251,191,36,0.08);">
            <div class="small">
              {% if latest_summary.get('peak_hour') %}
              <span class="me-3"><i class="bi bi-clock me-1" style="color: #fbbf24;"></i>{% if current_lang == 'he' %}×©×¢×ª ×©×™×:{% elif current_lang == 'en' %}Peak:{% else %}ĞŸĞ¸Ğº:{% endif %} {{ latest_summary.get('peak_hour') }}</span>
              {% endif %}
              {% if latest_summary.get('best_day') %}
              <span><i class="bi bi-calendar-check me-1" style="color: #fbbf24;"></i>{% if current_lang == 'he' %}×™×•× ×”×›×™ ×˜×•×‘:{% elif current_lang == 'en' %}Best:{% else %}Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹:{% endif %} {{ latest_summary.get('best_day') }}</span>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Forecast & Recommendations -->
  {% if total_sales > 0 %}
  <div class="card mb-4" style="border: 2px solid rgba(46,160,255,0.2); border-radius: 16px; background: linear-gradient(135deg, rgba(46,160,255,0.03), transparent);">
    <div class="card-header bg-transparent" style="border-bottom: 1px solid rgba(46,160,255,0.1);">
      <h5 class="mb-0">
        <i class="bi bi-bullseye me-2" style="color: #2ea0ff;"></i>
        {% if current_lang == 'he' %}×ª×—×–×™×ª ×•×”××œ×¦×•×ª{% elif current_lang == 'en' %}Forecast & Recommendations{% else %}ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸{% endif %}
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-md-4">
          <div class="text-center p-3 rounded-3" style="background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2);">
            <div class="small text-muted mb-1">{% if current_lang == 'he' %}×ª×—×–×™×ª ×œ×—×•×“×© ×”×‘×{% elif current_lang == 'en' %}Next Month Forecast{% else %}ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° ÑĞ». Ğ¼ĞµÑÑÑ†{% endif %}</div>
            <div class="h4 mb-0" style="color: #10b981;">
              {% if comparison and comparison.changes.total_pct %}
                {% set forecast = latest_summary.get('total_sales', 0) * (1 + comparison.changes.total_pct / 100) %}
                {{ currency_symbol }}{{ "{:,.0f}".format(forecast) }}
              {% else %}
                {{ currency_symbol }}{{ "{:,.0f}".format(latest_summary.get('total_sales', 0)) }}
              {% endif %}
            </div>
            <div class="small text-muted">{% if current_lang == 'he' %}×‘×”×ª×‘×¡×¡ ×¢×œ ×”××’××”{% elif current_lang == 'en' %}based on trend{% else %}Ğ¿Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ´Ñƒ{% endif %}</div>
          </div>
        </div>
        <div class="col-md-8">
          <h6 class="mb-2">{% if current_lang == 'he' %}×”××œ×¦×•×ª ×œ×¤×¢×•×œ×”{% elif current_lang == 'en' %}Action Recommendations{% else %}Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ{% endif %}</h6>
          <ul class="list-unstyled mb-0">
            {% if comparison and comparison.worst_day %}
            <li class="mb-2 d-flex align-items-start gap-2">
              <i class="bi bi-arrow-right-circle" style="color: #ef4444; margin-top: 2px;"></i>
              <span>{% if current_lang == 'he' %}×©×¤×¨ ××ª ×”××›×™×¨×•×ª ×‘×™×•× {{ comparison.worst_day.name }} â€“ ×”×•× ×”×™×•× ×”×—×œ×© ×‘×™×•×ª×¨{% elif current_lang == 'en' %}Improve sales on {{ comparison.worst_day.name }} â€“ it's the weakest day{% else %}Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ² {{ comparison.worst_day.name }} â€“ ÑÑ‚Ğ¾ ÑĞ°Ğ¼Ñ‹Ğ¹ ÑĞ»Ğ°Ğ±Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ{% endif %}</span>
            </li>
            {% endif %}
            {% if comparison and comparison.changes.avg_ticket_pct|default(0) < 0 %}
            <li class="mb-2 d-flex align-items-start gap-2">
              <i class="bi bi-arrow-right-circle" style="color: #f59e0b; margin-top: 2px;"></i>
              <span>{% if current_lang == 'he' %}×”×××•×¦×¢ ×œ×¢×¡×§×” ×™×¨×“ â€“ × ×¡×” ×œ×”×¦×™×¢ ×—×‘×™×œ×•×ª ××• ××•×¦×¨×™× ××©×œ×™××™×{% elif current_lang == 'en' %}Average ticket decreased â€“ try offering bundles or complementary products{% else %}Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº ÑĞ½Ğ¸Ğ·Ğ¸Ğ»ÑÑ â€“ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ñ‹{% endif %}</span>
            </li>
            {% endif %}
            <li class="d-flex align-items-start gap-2">
              <i class="bi bi-arrow-right-circle" style="color: #10b981; margin-top: 2px;"></i>
              <span>{% if current_lang == 'he' %}×”×¢×œ×” ×“×•×— ×—×“×© ×‘×›×œ ×©×‘×•×¢ ×›×“×™ ×œ×¢×§×•×‘ ××—×¨ ×”×©×™× ×•×™×™×{% elif current_lang == 'en' %}Upload a new report weekly to track changes{% else %}Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ{% endif %}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ×˜×™×¤ ×œ×©×™××•×© -->
  <div class="alert mb-4" style="border-radius: 12px; background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2);">
    <div class="d-flex gap-3">
      <div class="fs-3">ğŸ’¡</div>
      <div>
        <strong>{% if current_lang == 'he' %}×˜×™×¤:{% elif current_lang == 'en' %}Tip:{% else %}Ğ¡Ğ¾Ğ²ĞµÑ‚:{% endif %}</strong> {% if current_lang == 'he' %}×”×¢×œ×” ×“×•×—×•×ª ××ª×§×•×¤×•×ª ×©×•× ×•×ª (×—×•×“×© ×©×¢×‘×¨, ×”×©×‘×•×¢ ×”×–×”) ×›×“×™ ×œ×¨××•×ª ×”×©×•×•××” ××•×˜×•××˜×™×ª!{% elif current_lang == 'en' %}Upload reports from different periods (last month, this week) to see automatic comparison!{% else %}Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ğ¹Ñ‚Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ² (Ğ¿Ñ€Ğ¾ÑˆĞ»Ñ‹Ğ¹ Ğ¼ĞµÑÑÑ†, ÑÑ‚Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ!{% endif %}
        <br>
        <small class="text-muted">{% if current_lang == 'he' %}×‘×¢×ª ×”×¢×œ××ª ×“×•×—, ×‘×—×¨ ××ª ×¡×•×’ ×”×ª×§×•×¤×” (×—×•×“×©/×©×‘×•×¢/×™×•×) ×›×“×™ ×œ××¨×’×Ÿ ××ª ×”×”×©×•×•××•×ª.{% elif current_lang == 'en' %}When uploading a report, select the period type (month/week/day) to organize comparisons.{% else %}ĞŸÑ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° (Ğ¼ĞµÑÑÑ†/Ğ½ĞµĞ´ĞµĞ»Ñ/Ğ´ĞµĞ½ÑŒ), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ.{% endif %}</small>
      </div>
    </div>
  </div>

  <!-- ××‘×˜×—×ª ××™×“×¢ -->
  <div class="alert alert-secondary mt-3">
    <strong>ğŸ” {% if current_lang == 'he' %}××‘×˜×—×ª ××™×“×¢:{% elif current_lang == 'en' %}Data Security:{% else %}Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:{% endif %}</strong> {% if current_lang == 'he' %}×›×œ ×”× ×ª×•× ×™× ×©×œ×š ××•×¦×¤× ×™× ×‘×”×¦×¤× ×ª AES-256 (Fernet) ×•× ×©××¨×™× ×‘×¦×•×¨×” ×××•×‘×˜×—×ª. ×¨×§ ××ª×” ×™×›×•×œ ×œ×’×©×ª ×œ×“×•×—×•×ª ×©×œ×š.{% elif current_lang == 'en' %}All your data is encrypted with AES-256 (Fernet) encryption and stored securely. Only you can access your reports.{% else %}Ğ’ÑĞµ Ğ²Ğ°ÑˆĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AES-256 (Fernet) Ğ¸ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ÑĞ²Ğ¾Ğ¸Ğ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°Ğ¼.{% endif %}
  </div>
</div>

<!-- ××•×“×œ ×œ×”×©×•×•××ª ×ª×§×•×¤×•×ª -->
{% if reports|length >= 2 %}
<div class="modal fade" id="compareModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <h5 class="modal-title mb-0"><i class="bi bi-bar-chart me-2"></i>{% if current_lang == 'he' %}×”×©×•×•××ª ×ª×§×•×¤×•×ª{% elif current_lang == 'en' %}Compare Periods{% else %}Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹{% endif %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('dashboard_compare') }}" id="compareForm">
        <div class="modal-body p-4">
          <p class="text-muted mb-4">{% if current_lang == 'he' %}×‘×—×¨ ×©×ª×™ ×ª×§×•×¤×•×ª ×××•×ª×• ×¡×•×’ ×œ×”×©×•×•××”:{% elif current_lang == 'en' %}Select two periods of the same type to compare:{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ²Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ:{% endif %}</p>
          
          <!-- Tabs for period types -->
          <ul class="nav nav-pills mb-4" id="periodTypeTabs" role="tablist" style="border-bottom: 2px solid #e9ecef;">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="months-tab" data-bs-toggle="tab" data-bs-target="#months" type="button" role="tab" style="border-radius: 8px 8px 0 0; font-weight: 500;">
                <i class="bi bi-calendar-month me-2"></i>
                {% if current_lang == 'he' %}×—×•×“×©×™×{% elif current_lang == 'en' %}Months{% else %}ĞœĞµÑÑÑ†Ñ‹{% endif %}
                <span class="badge bg-primary ms-2">{{ reports_by_type.month|length }}</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="weeks-tab" data-bs-toggle="tab" data-bs-target="#weeks" type="button" role="tab" style="border-radius: 8px 8px 0 0; font-weight: 500;">
                <i class="bi bi-calendar-week me-2"></i>
                {% if current_lang == 'he' %}×©×‘×•×¢×•×ª{% elif current_lang == 'en' %}Weeks{% else %}ĞĞµĞ´ĞµĞ»Ğ¸{% endif %}
                <span class="badge bg-success ms-2">{{ reports_by_type.week|length }}</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="days-tab" data-bs-toggle="tab" data-bs-target="#days" type="button" role="tab" style="border-radius: 8px 8px 0 0; font-weight: 500;">
                <i class="bi bi-calendar-day me-2"></i>
                {% if current_lang == 'he' %}×™××™×{% elif current_lang == 'en' %}Days{% else %}Ğ”Ğ½Ğ¸{% endif %}
                <span class="badge bg-info ms-2">{{ reports_by_type.day|length }}</span>
              </button>
            </li>
            {% if reports_by_type.custom|length > 0 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab" style="border-radius: 8px 8px 0 0; font-weight: 500;">
                <i class="bi bi-calendar-event me-2"></i>
                {% if current_lang == 'he' %}××•×ª×× ××™×©×™×ª{% elif current_lang == 'en' %}Custom{% else %}Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ{% endif %}
                <span class="badge bg-secondary ms-2">{{ reports_by_type.custom|length }}</span>
              </button>
            </li>
            {% endif %}
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content" id="periodTypeTabContent">
            <!-- Months Tab -->
            <div class="tab-pane fade show active" id="months" role="tabpanel">
              {% if reports_by_type.month|length >= 2 %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check me-2" style="color: #667eea;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×¨××©×•× ×” (×™×©× ×” ×™×•×ª×¨){% elif current_lang == 'en' %}First Period (older){% else %}ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (ÑÑ‚Ğ°Ñ€ÑˆĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="month" data-field-type="report1" required style="border-radius: 10px; border: 2px solid #667eea; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×—×•×“×©...{% elif current_lang == 'en' %}Select month...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ†...{% endif %}</option>
                    {% for report in reports_by_type.month %}
                    <option value="{{ report.id }}" style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“… {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check-fill me-2" style="color: #764ba2;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×©× ×™×™×” (×—×“×©×” ×™×•×ª×¨){% elif current_lang == 'en' %}Second Period (newer){% else %}Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ½Ğ¾Ğ²ĞµĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="month" data-field-type="report2" required style="border-radius: 10px; border: 2px solid #764ba2; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×—×•×“×©...{% elif current_lang == 'en' %}Select month...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ†...{% endif %}</option>
                    {% for report in reports_by_type.month %}
                    <option value="{{ report.id }}" {% if loop.first %}selected{% endif %} style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“… {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning mb-0" style="border-radius: 12px; background-color: #fef3c7 !important; border: 1px solid #f59e0b !important; color: #92400e !important;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span style="color: #92400e !important;">{% if current_lang == 'he' %}× ×“×¨×©×™× ×œ×¤×—×•×ª 2 ×“×•×—×•×ª ×—×•×“×©×™×™× ×œ×”×©×•×•××”{% elif current_lang == 'en' %}At least 2 monthly reports required for comparison{% else %}ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ{% endif %}</span>
              </div>
              {% endif %}
            </div>
            
            <!-- Weeks Tab -->
            <div class="tab-pane fade" id="weeks" role="tabpanel">
              {% if reports_by_type.week|length >= 2 %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check me-2" style="color: #10b981;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×¨××©×•× ×” (×™×©× ×” ×™×•×ª×¨){% elif current_lang == 'en' %}First Period (older){% else %}ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (ÑÑ‚Ğ°Ñ€ÑˆĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="week" data-field-type="report1" required style="border-radius: 10px; border: 2px solid #10b981; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×©×‘×•×¢...{% elif current_lang == 'en' %}Select week...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ĞµĞ´ĞµĞ»Ñ...{% endif %}</option>
                    {% for report in reports_by_type.week %}
                    <option value="{{ report.id }}" style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“† {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check-fill me-2" style="color: #059669;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×©× ×™×™×” (×—×“×©×” ×™×•×ª×¨){% elif current_lang == 'en' %}Second Period (newer){% else %}Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ½Ğ¾Ğ²ĞµĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="week" data-field-type="report2" required style="border-radius: 10px; border: 2px solid #059669; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×©×‘×•×¢...{% elif current_lang == 'en' %}Select week...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ĞµĞ´ĞµĞ»Ñ...{% endif %}</option>
                    {% for report in reports_by_type.week %}
                    <option value="{{ report.id }}" {% if loop.first %}selected{% endif %} style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“† {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning mb-0" style="border-radius: 12px;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {% if current_lang == 'he' %}× ×“×¨×©×™× ×œ×¤×—×•×ª 2 ×“×•×—×•×ª ×©×‘×•×¢×™×™× ×œ×”×©×•×•××”{% elif current_lang == 'en' %}At least 2 weekly reports required for comparison{% else %}ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ{% endif %}
              </div>
              {% endif %}
            </div>
            
            <!-- Days Tab -->
            <div class="tab-pane fade" id="days" role="tabpanel">
              {% if reports_by_type.day|length >= 2 %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check me-2" style="color: #3b82f6;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×¨××©×•× ×” (×™×©× ×” ×™×•×ª×¨){% elif current_lang == 'en' %}First Period (older){% else %}ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (ÑÑ‚Ğ°Ñ€ÑˆĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="day" data-field-type="report1" required style="border-radius: 10px; border: 2px solid #3b82f6; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×™×•×...{% elif current_lang == 'en' %}Select day...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ½ÑŒ...{% endif %}</option>
                    {% for report in reports_by_type.day %}
                    <option value="{{ report.id }}" style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“Œ {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check-fill me-2" style="color: #2563eb;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×©× ×™×™×” (×—×“×©×” ×™×•×ª×¨){% elif current_lang == 'en' %}Second Period (newer){% else %}Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ½Ğ¾Ğ²ĞµĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="day" data-field-type="report2" required style="border-radius: 10px; border: 2px solid #2563eb; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×™×•×...{% elif current_lang == 'en' %}Select day...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ½ÑŒ...{% endif %}</option>
                    {% for report in reports_by_type.day %}
                    <option value="{{ report.id }}" {% if loop.first %}selected{% endif %} style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“Œ {{ report.name }} ({{ report.period_start or '?' }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              {% else %}
              <div class="alert alert-warning mb-0" style="border-radius: 12px;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {% if current_lang == 'he' %}× ×“×¨×©×™× ×œ×¤×—×•×ª 2 ×“×•×—×•×ª ×™×•××™×™× ×œ×”×©×•×•××”{% elif current_lang == 'en' %}At least 2 daily reports required for comparison{% else %}ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ{% endif %}
              </div>
              {% endif %}
            </div>
            
            <!-- Custom Tab -->
            {% if reports_by_type.custom|length > 0 %}
            <div class="tab-pane fade" id="custom" role="tabpanel">
              {% if reports_by_type.custom|length >= 2 %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check me-2" style="color: #6b7280;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×¨××©×•× ×” (×™×©× ×” ×™×•×ª×¨){% elif current_lang == 'en' %}First Period (older){% else %}ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (ÑÑ‚Ğ°Ñ€ÑˆĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="custom" data-field-type="report1" required style="border-radius: 10px; border: 2px solid #6b7280; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×ª×§×•×¤×”...{% elif current_lang == 'en' %}Select period...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´...{% endif %}</option>
                    {% for report in reports_by_type.custom %}
              <option value="{{ report.id }}" style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“‹ {{ report.name }} ({{ report.period_start or '?' }})
              </option>
              {% endfor %}
            </select>
          </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold mb-2">
                    <i class="bi bi-calendar-check-fill me-2" style="color: #4b5563;"></i>
                    {% if current_lang == 'he' %}×ª×§×•×¤×” ×©× ×™×™×” (×—×“×©×” ×™×•×ª×¨){% elif current_lang == 'en' %}Second Period (newer){% else %}Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ½Ğ¾Ğ²ĞµĞµ){% endif %}
                  </label>
                  <select class="form-select period-select" data-period-type="custom" data-field-type="report2" required style="border-radius: 10px; border: 2px solid #4b5563; padding: 12px; background-color: rgba(13,42,68,0.5); color: #e6e9ef;">
                    <option value="" style="background-color: #1e293b; color: #e6e9ef;">{% if current_lang == 'he' %}×‘×—×¨ ×ª×§×•×¤×”...{% elif current_lang == 'en' %}Select period...{% else %}Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´...{% endif %}</option>
                    {% for report in reports_by_type.custom %}
              <option value="{{ report.id }}" {% if loop.first %}selected{% endif %} style="background-color: #1e293b; color: #e6e9ef;">
                      ğŸ“‹ {{ report.name }} ({{ report.period_start or '?' }})
              </option>
              {% endfor %}
            </select>
          </div>
              </div>
              {% else %}
              <div class="alert alert-warning mb-0" style="border-radius: 12px;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {% if current_lang == 'he' %}× ×“×¨×©×™× ×œ×¤×—×•×ª 2 ×“×•×—×•×ª ××•×ª×××™× ××™×©×™×ª ×œ×”×©×•×•××”{% elif current_lang == 'en' %}At least 2 custom reports required for comparison{% else %}ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ{% endif %}
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
          
          <div class="alert alert-info mt-4 mb-0" style="border-radius: 12px; background: rgba(59,130,246,0.1) !important; border: 1px solid rgba(59,130,246,0.3) !important; color: #1e40af !important;">
            <i class="bi bi-info-circle me-2" style="color: #2563eb !important;"></i>
            <small style="color: #1e40af !important; font-weight: 500;">{% if current_lang == 'he' %}××•××œ×¥ ×œ×”×©×•×•×ª ×ª×§×•×¤×•×ª ×××•×ª×• ×¡×•×’ ×œ×§×‘×œ×ª ×ª×•×¦××•×ª ××“×•×™×§×•×ª ×™×•×ª×¨{% elif current_lang == 'en' %}Recommended to compare periods of the same type for more accurate results{% else %}Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²{% endif %}</small>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e9ecef; padding: 16px 24px;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px; padding: 10px 20px;">{{ t('cancel') }}</button>
          <button type="submit" class="btn btn-primary" style="border-radius: 8px; padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
            <i class="bi bi-bar-chart me-2"></i> {% if current_lang == 'he' %}×”×©×•×•×”{% elif current_lang == 'en' %}Compare{% else %}Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Handle tab switching and form validation
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('compareForm');
  if (!form) return;
  
  // Reset selects when switching tabs
  const tabButtons = document.querySelectorAll('#periodTypeTabs button[data-bs-toggle="tab"]');
  tabButtons.forEach(btn => {
    btn.addEventListener('shown.bs.tab', function(e) {
      const targetId = e.target.getAttribute('data-bs-target');
      const activePane = document.querySelector(targetId);
      
      // Clear all selects and reset required
      document.querySelectorAll('.period-select').forEach(select => {
        const isInActivePane = activePane && activePane.contains(select);
        if (!isInActivePane) {
          select.value = '';
          select.removeAttribute('required');
          select.style.borderColor = '#e9ecef';
        } else {
          select.setAttribute('required', 'required');
        }
      });
    });
  });
  
  // Handle form submission with AJAX
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    const activeTab = document.querySelector('#periodTypeTabs .nav-link.active');
    if (!activeTab) {
      e.preventDefault();
      return;
    }
    
    const targetId = activeTab.getAttribute('data-bs-target');
    const activeTabPane = document.querySelector(targetId);
    if (!activeTabPane) {
      e.preventDefault();
      return;
    }
    
    // Clear all select fields first
    document.querySelectorAll('.period-select').forEach(select => {
      // Remove name attribute to prevent submission
      select.removeAttribute('name');
    });
    
    // Get selects from active tab pane
    const report1Select = activeTabPane.querySelector('.period-select[data-field-type="report1"]');
    const report2Select = activeTabPane.querySelector('.period-select[data-field-type="report2"]');
    
    let isValid = true;
    
    // Set name attributes for active selects
    if (report1Select) {
      report1Select.setAttribute('name', 'report1_id');
      if (!report1Select.value) {
        isValid = false;
        report1Select.style.borderColor = '#ef4444';
        report1Select.style.borderWidth = '2px';
      } else {
        report1Select.style.borderColor = '#10b981';
        report1Select.style.borderWidth = '2px';
      }
    }
    
    if (report2Select) {
      report2Select.setAttribute('name', 'report2_id');
      if (!report2Select.value) {
        isValid = false;
        report2Select.style.borderColor = '#ef4444';
        report2Select.style.borderWidth = '2px';
      } else {
        report2Select.style.borderColor = '#10b981';
        report2Select.style.borderWidth = '2px';
      }
    }
    
    if (!isValid) {
      // Remove name attributes on validation failure
      if (report1Select) report1Select.removeAttribute('name');
      if (report2Select) report2Select.removeAttribute('name');
      {% if current_lang == 'he' %}
      alert('×× × ×‘×—×¨ ××ª ×©× ×™ ×”×ª×§×•×¤×•×ª ×œ×”×©×•×•××”');
      {% elif current_lang == 'en' %}
      alert('Please select both periods for comparison');
      {% else %}
      alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ');
      {% endif %}
      return;
    }
    
    // Prevent default form submission
    e.preventDefault();
    
    // Prepare form data
    const formData = new FormData(form);
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{% if current_lang == "he" %}××©×•×•×”...{% elif current_lang == "en" %}Comparing...{% else %}Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼...{% endif %}';
    
    // Send AJAX request
    fetch('{{ url_for("dashboard_compare") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
      
      // Check for errors
      if (data.error) {
        {% if current_lang == 'he' %}
        alert('×©×’×™××”: ' + data.error);
        {% elif current_lang == 'en' %}
        alert('Error: ' + data.error);
        {% else %}
        alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + data.error);
        {% endif %}
        return;
      }
      
      // Close modal
      const modalElement = document.getElementById('compareModal');
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
      
      // Check if data is identical (all changes are 0 or very close to 0)
      const changes = data.changes || {};
      const allChangesZero = Math.abs(changes.total_pct || 0) < 0.01 && 
        Math.abs(changes.avg_daily_pct || 0) < 0.01 && 
        Math.abs(changes.transactions_pct || 0) < 0.01 && 
        (Math.abs(changes.avg_ticket_pct || 0) < 0.01 || changes.avg_ticket_pct === null);
      
      if (allChangesZero) {
        // Show beautiful message for identical data
        showIdenticalDataMessage(data);
      } else {
        // Reload page to show comparison results
        window.location.reload();
      }
    })
    .catch(error => {
      submitButton.disabled = false;
      submitButton.innerHTML = originalButtonText;
      console.error('Error:', error);
      {% if current_lang == 'he' %}
      alert('×©×’×™××” ×‘×”×©×•×•××”. ×× × × ×¡×” ×©×•×‘.');
      {% elif current_lang == 'en' %}
      alert('Comparison error. Please try again.');
      {% else %}
      alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.');
      {% endif %}
    });
  });
  
  // Function to show identical data message
  function showIdenticalDataMessage(data) {
    // Remove existing comparison message if any
    const existingMsg = document.getElementById('comparisonResultMessage');
    if (existingMsg) existingMsg.remove();
    
    const total = data.period2 ? data.period2.total : (data.period1 ? data.period1.total : 0);
    const days = data.period2 ? data.period2.days : (data.period1 ? data.period1.days : 0);
    const currencySymbol = '{{ currency_symbol }}';
    
    // Create beautiful message card
    const messageCard = document.createElement('div');
    messageCard.id = 'comparisonResultMessage';
    messageCard.className = 'card shadow-lg mb-4';
    messageCard.style.cssText = 'border: none; border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); box-shadow: 0 10px 40px rgba(59,130,246,0.2);';
    
    messageCard.innerHTML = `
      <div class="card-body text-center p-5">
        <div style="width: 100px; height: 100px; margin: 0 auto 30px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(59,130,246,0.3);">
          <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: white;"></i>
        </div>
        <h3 class="mb-3" style="color: #1e40af; font-weight: 700;">
          {% if current_lang == 'he' %}
          ğŸ“Š ×”× ×ª×•× ×™× ×–×”×™× ×œ×—×œ×•×˜×™×Ÿ
          {% elif current_lang == 'en' %}
          ğŸ“Š Data is Identical
          {% else %}
          ğŸ“Š Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ‡Ğ½Ñ‹
          {% endif %}
        </h3>
        <p class="lead mb-4" style="color: #1e3a8a; font-size: 1.2rem;">
          {% if current_lang == 'he' %}
          ×©× ×™ ×”×ª×§×•×¤×•×ª ×–×”×•×ª ×œ×—×œ×•×˜×™×Ÿ - ××™×Ÿ ×”×‘×“×œ ×‘×›×œ ×”××“×“×™×.
          {% elif current_lang == 'en' %}
          Both periods are completely identical - no difference in any metrics.
          {% else %}
          ĞĞ±Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ‡Ğ½Ñ‹ - Ğ½ĞµÑ‚ Ñ€Ğ°Ğ·Ğ½Ğ¸Ñ†Ñ‹ Ğ½Ğ¸ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ñ.
          {% endif %}
        </p>
        <div class="row g-4 mb-4" style="max-width: 700px; margin-left: auto; margin-right: auto;">
          <div class="col-md-4">
            <div class="p-4 rounded-4" style="background: rgba(255,255,255,0.8); border: 2px solid rgba(59,130,246,0.2);">
              <div class="small text-muted mb-2" style="font-weight: 500;">{% if current_lang == 'he' %}×¡×”"×› ××›×™×¨×•×ª{% elif current_lang == 'en' %}Total Sales{% else %}ĞĞ±Ñ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸{% endif %}</div>
              <div class="h4 mb-0" style="color: #1e40af; font-weight: 700;">${currencySymbol}${parseFloat(total).toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-4 rounded-4" style="background: rgba(255,255,255,0.8); border: 2px solid rgba(59,130,246,0.2);">
              <div class="small text-muted mb-2" style="font-weight: 500;">{% if current_lang == 'he' %}×©×™× ×•×™ ×›×•×œ×œ{% elif current_lang == 'en' %}Total Change{% else %}ĞĞ±Ñ‰ĞµĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ{% endif %}</div>
              <div class="h4 mb-0" style="color: #64748b; font-weight: 700;">0%</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-4 rounded-4" style="background: rgba(255,255,255,0.8); border: 2px solid rgba(59,130,246,0.2);">
              <div class="small text-muted mb-2" style="font-weight: 500;">{% if current_lang == 'he' %}×™××™×{% elif current_lang == 'en' %}Days{% else %}Ğ”Ğ½ĞµĞ¹{% endif %}</div>
              <div class="h4 mb-0" style="color: #1e40af; font-weight: 700;">${days}</div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary btn-lg px-5 py-3" onclick="this.closest('#comparisonResultMessage').remove();" style="border-radius: 12px; font-weight: 600;">
          <i class="bi bi-x-circle me-2"></i>
          {% if current_lang == 'he' %}×¡×’×•×¨{% elif current_lang == 'en' %}Close{% else %}Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ{% endif %}
        </button>
      </div>
    `;
    
    // Insert message at the top of dashboard content
    const dashboardContent = document.querySelector('.container.my-5');
    if (dashboardContent) {
      dashboardContent.insertBefore(messageCard, dashboardContent.firstChild);
      messageCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
  
  // Visual feedback on select change
  document.querySelectorAll('.period-select').forEach(select => {
    select.addEventListener('change', function() {
      if (this.value) {
        this.style.borderColor = '#10b981';
        this.style.borderWidth = '2px';
      } else {
        // Reset to default border color based on period type
        const periodType = this.getAttribute('data-period-type');
        if (periodType === 'month') {
          this.style.borderColor = '#667eea';
        } else if (periodType === 'week') {
          this.style.borderColor = '#10b981';
        } else if (periodType === 'day') {
          this.style.borderColor = '#3b82f6';
        } else {
          this.style.borderColor = '#6b7280';
        }
        this.style.borderWidth = '2px';
      }
    });
    
    // Initial state check
    if (select.value) {
      select.style.borderColor = '#10b981';
      select.style.borderWidth = '2px';
    } else {
      // Set default border color based on period type
      const periodType = select.getAttribute('data-period-type');
      if (periodType === 'month') {
        select.style.borderColor = '#667eea';
      } else if (periodType === 'week') {
        select.style.borderColor = '#10b981';
      } else if (periodType === 'day') {
        select.style.borderColor = '#3b82f6';
      } else {
        select.style.borderColor = '#6b7280';
      }
      select.style.borderWidth = '2px';
    }
  });
});
</script>
{% endif %}

<style>
  /* Remove all text decorations */
  .container.my-5 h1,
  .container.my-5 h2,
  .container.my-5 h3,
  .container.my-5 h4,
  .container.my-5 h5,
  .container.my-5 h6,
  .container.my-5 a,
  .container.my-5 strong,
  .container.my-5 th,
  .container.my-5 td,
  .container.my-5 .card-title,
  .container.my-5 .card-subtitle,
  .container.my-5 span {
    text-decoration: none !important;
  }
  
  .card { border-radius: 12px; }
  .card-header { border-radius: 12px 12px 0 0 !important; }
  .badge { font-weight: 500; }
  
  /* Modal styles */
  #compareModal .modal-content {
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    background-color: #ffffff !important;
  }
  
  #compareModal .modal-body {
    background-color: #ffffff !important;
    color: #1e293b !important;
  }
  
  #compareModal .nav-pills .nav-link {
    color: #6c757d !important;
    border: none !important;
    border-bottom: 3px solid transparent !important;
    margin-right: 8px;
    transition: all 0.3s ease;
    background-color: transparent !important;
  }
  
  #compareModal .nav-pills .nav-link:hover {
    color: #667eea !important;
    background-color: rgba(102, 126, 234, 0.1) !important;
    border-bottom-color: rgba(102, 126, 234, 0.3) !important;
  }
  
  #compareModal .nav-pills .nav-link.active {
    color: #667eea !important;
    background-color: rgba(102, 126, 234, 0.1) !important;
    border-bottom-color: #667eea !important;
    font-weight: 600;
  }
  
  #compareModal .form-select {
    transition: all 0.3s ease;
  }
  
  #compareModal .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
  }
  
  #compareModal .period-select {
    font-size: 15px;
  }
  
  #compareModal .tab-pane {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  #compareModal .alert {
    border-left: 4px solid;
  }
  
  #compareModal .alert-info {
    border-left-color: #3b82f6;
  }
  
  #compareModal .alert-warning {
    border-left-color: #f59e0b;
  }
  
  /* Reports table dark theme */
  .table.reports-table {
    background-color: rgba(13,42,68,0.8) !important;
    color: #e6e9ef !important;
  }
  
  .table.reports-table thead {
    background-color: rgba(15, 23, 42, 0.95) !important;
    color: #e6e9ef !important;
    border-bottom: 2px solid rgba(102, 126, 234, 0.4) !important;
  }
  
  .table.reports-table thead th {
    color: #e6e9ef !important;
    font-weight: 600;
    padding: 16px !important;
    border-bottom: 2px solid rgba(102, 126, 234, 0.4) !important;
    background-color: rgba(15, 23, 42, 0.95) !important;
  }
  
  .table.reports-table tbody {
    background-color: rgba(13,42,68,0.8) !important;
  }
  
  .table.reports-table tbody tr {
    border-bottom: 1px solid rgba(102, 126, 234, 0.2) !important;
    color: #e6e9ef !important;
    background-color: rgba(13,42,68,0.8) !important;
  }
  
  .table.reports-table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.25) !important;
    transition: background-color 0.2s ease;
  }
  
  .table.reports-table tbody td {
    padding: 14px 16px !important;
    color: #e6e9ef !important;
    vertical-align: middle;
    background-color: transparent !important;
  }
  
  .table.reports-table tbody td strong {
    color: #ffffff !important;
    font-weight: 600;
  }
  
  .table.reports-table tbody td small {
    color: #cbd5e1 !important;
  }
  
  .table.reports-table .badge {
    color: #ffffff !important;
    font-weight: 500;
  }
  
  /* Improve form label visibility in modal */
  #compareModal .form-label {
    color: #1e293b !important;
    font-weight: 600;
  }
  
  /* Modal body background */
  #compareModal .modal-body {
    background-color: #ffffff !important;
    color: #1e293b !important;
  }
  
  #compareModal .modal-body p {
    color: #1e293b !important;
  }
  
  /* Improve select field visibility */
  #compareModal .period-select {
    background-color: rgba(13,42,68,0.9) !important;
    color: #e6e9ef !important;
    border-width: 2px !important;
  }
  
  #compareModal .period-select option {
    background-color: #1e293b !important;
    color: #e6e9ef !important;
  }
  
  /* Select focus state */
  #compareModal .period-select:focus {
    background-color: rgba(13,42,68,0.95) !important;
    color: #ffffff !important;
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
  }
</style>
{% endblock %}
