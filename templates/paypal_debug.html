<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #0070ba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #005a94;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error {
            color: #f00;
        }
        .success {
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>üîç PayPal Payment Debug Test</h1>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoint</h2>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–∞–µ—Ç –ª–∏ /api/paypal/create-order</p>
        <button onclick="testCreateOrder('basic')">Test BASIC Plan</button>
        <button onclick="testCreateOrder('pro')">Test PRO Plan</button>
        <div id="log1" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ PayPal SDK</h2>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ PayPal SDK</p>
        <button onclick="testPayPalSDK()">Check PayPal SDK</button>
        <div id="log2" class="log"></div>
    </div>

    <div class="test-section">
        <h2>–¢–µ—Å—Ç 3: –ü–æ–ª–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞</h2>
        <p>–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</p>
        <button onclick="testFullFlow('basic')">Simulate BASIC Payment</button>
        <button onclick="testFullFlow('pro')">Simulate PRO Payment</button>
        <div id="log3" class="log"></div>
    </div>

    <script>
        function log(logId, message, type = 'info') {
            const logEl = document.getElementById(logId);
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            logEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog(logId) {
            document.getElementById(logId).innerHTML = '';
        }

        async function testCreateOrder(plan) {
            clearLog('log1');
            log('log1', `–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø–ª–∞–Ω–∞: ${plan}...`);
            
            try {
                log('log1', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/paypal/create-order...');
                const response = await fetch('/api/paypal/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ plan: plan })
                });
                
                log('log1', `–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                log('log1', `–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    if (data.error) {
                        log('log1', `‚ùå –û–®–ò–ë–ö–ê: ${data.error}`, 'error');
                    } else if (data.approval_url) {
                        log('log1', `‚úÖ –£–°–ü–ï–•! –ü–æ–ª—É—á–µ–Ω approval_url`, 'success');
                        log('log1', `Subscription ID: ${data.id}`, 'success');
                        log('log1', `Approval URL: ${data.approval_url}`, 'success');
                    } else if (data.redirect) {
                        log('log1', `‚úÖ –£–°–ü–ï–•! –ü–æ–ª—É—á–µ–Ω redirect (–æ–ø–ª–∞—Ç–∞ –Ω–µ –Ω—É–∂–Ω–∞)`, 'success');
                        log('log1', `Redirect: ${data.redirect}`, 'success');
                    } else {
                        log('log1', `‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∏ approval_url, –Ω–∏ redirect`, 'error');
                    }
                } else {
                    log('log1', `‚ùå HTTP –û–®–ò–ë–ö–ê: ${response.status}`, 'error');
                    if (data.error) {
                        log('log1', `–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: ${data.error}`, 'error');
                    }
                }
            } catch (err) {
                log('log1', `‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: ${err.message}`, 'error');
                log('log1', `Stack trace: ${err.stack}`, 'error');
            }
        }

        function testPayPalSDK() {
            clearLog('log2');
            log('log2', '–ü—Ä–æ–≤–µ—Ä–∫–∞ PayPal SDK...');
            
            if (typeof paypal !== 'undefined') {
                log('log2', '‚úÖ PayPal SDK –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                log('log2', `paypal object: ${JSON.stringify(Object.keys(paypal), null, 2)}`, 'success');
                
                if (typeof paypal.Buttons === 'function') {
                    log('log2', '‚úÖ paypal.Buttons –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                } else {
                    log('log2', '‚ùå paypal.Buttons –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
            } else {
                log('log2', '‚ùå PayPal SDK –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω!', 'error');
                log('log2', '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', 'error');
                log('log2', '1. PAYPAL_CLIENT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
                log('log2', '2. –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ad-blocker', 'error');
                log('log2', '3. –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é', 'error');
            }
        }

        async function testFullFlow(plan) {
            clearLog('log3');
            log('log3', `üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–ª–∞–Ω–∞: ${plan}`);
            
            // Step 1: Check SDK
            log('log3', '\n--- –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ SDK ---');
            if (typeof paypal === 'undefined') {
                log('log3', '‚ùå PayPal SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'error');
                return;
            }
            log('log3', '‚úÖ PayPal SDK –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            
            // Step 2: Create order
            log('log3', '\n--- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ---');
            try {
                const response = await fetch('/api/paypal/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ plan: plan })
                });
                
                log('log3', `–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (!response.ok) {
                    const data = await response.json();
                    log('log3', `‚ùå –û–®–ò–ë–ö–ê: ${data.error || 'Unknown error'}`, 'error');
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    log('log3', `‚ùå –û–®–ò–ë–ö–ê –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${data.error}`, 'error');
                    return;
                }
                
                if (data.approval_url) {
                    log('log3', '‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    log('log3', `Subscription ID: ${data.id}`, 'success');
                    log('log3', `\nüìç –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ PayPal`, 'success');
                    log('log3', `URL: ${data.approval_url}`, 'success');
                    log('log3', `\n–í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω —Å–µ–π—á–∞—Å.`, 'success');
                } else if (data.redirect) {
                    log('log3', '‚úÖ –û–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Å–∫–∏–¥–∫–∞ –ø–æ–∫—Ä—ã–ª–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å)', 'success');
                    log('log3', `Redirect: ${data.redirect}`, 'success');
                } else {
                    log('log3', '‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                    log('log3', `Data: ${JSON.stringify(data, null, 2)}`, 'error');
                }
                
            } catch (err) {
                log('log3', `‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: ${err.message}`, 'error');
                console.error(err);
            }
        }
    </script>
</body>
</html>

